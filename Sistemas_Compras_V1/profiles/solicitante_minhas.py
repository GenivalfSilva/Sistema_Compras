"""
M√≥dulo para visualiza√ß√£o das solicita√ß√µes do usu√°rio logado
Cont√©m: Lista filtrada por solicitante, acompanhamento de status
"""

import streamlit as st
import pandas as pd
import datetime
from typing import Dict

def minhas_solicitacoes(data: Dict, usuario: Dict, USE_DATABASE: bool = False):
    """Renderiza a p√°gina de Minhas Solicita√ß√µes para o solicitante"""
    from style import get_section_header_html, get_info_box_html, get_stats_card_html
    from app import format_brl
    
    st.markdown(get_section_header_html('üìã Minhas Solicita√ß√µes'), unsafe_allow_html=True)
    st.markdown(get_info_box_html('üë§ <strong>Visualizando apenas suas solicita√ß√µes</strong>'), unsafe_allow_html=True)
    
    # Filtra solicita√ß√µes do usu√°rio logado
    nome_usuario = usuario.get('nome', usuario.get('username', ''))
    minhas_sols = []
    
    for sol in data.get("solicitacoes", []):
        # Compara com nome ou username do solicitante
        solicitante = sol.get('solicitante', '')
        if solicitante.lower() == nome_usuario.lower() or solicitante.lower() == usuario.get('username', '').lower():
            minhas_sols.append(sol)
    
    if not minhas_sols:
        st.info("üìã Voc√™ ainda n√£o possui solicita√ß√µes criadas.")
        st.markdown("üí° Use a op√ß√£o **'üìù Nova Solicita√ß√£o'** para criar sua primeira solicita√ß√£o.")
        return
    
    # M√©tricas do usu√°rio
    st.markdown("### üìä Resumo das Suas Solicita√ß√µes")
    col1, col2, col3, col4 = st.columns(4)
    
    total_minhas = len(minhas_sols)
    pendentes = len([s for s in minhas_sols if s.get('status') not in ['Pedido Finalizado', 'Reprovado']])
    aprovadas = len([s for s in minhas_sols if s.get('status') == 'Aprovado'])
    finalizadas = len([s for s in minhas_sols if s.get('status') == 'Pedido Finalizado'])
    
    with col1:
        st.markdown(get_stats_card_html(str(total_minhas), "üìã Total"), unsafe_allow_html=True)
    with col2:
        st.markdown(get_stats_card_html(str(pendentes), "‚è≥ Em Andamento"), unsafe_allow_html=True)
    with col3:
        st.markdown(get_stats_card_html(str(aprovadas), "‚úÖ Aprovadas"), unsafe_allow_html=True)
    with col4:
        st.markdown(get_stats_card_html(str(finalizadas), "üèÅ Finalizadas"), unsafe_allow_html=True)
    
    # Filtros
    st.markdown("### üîç Filtros")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        status_filtro = st.selectbox("Status:", 
            ["Todos", "Solicita√ß√£o", "Suprimentos", "Em Cota√ß√£o", "Aguardando Aprova√ß√£o", "Aprovado", "Reprovado", "Pedido Finalizado"])
    with col2:
        prioridade_filtro = st.selectbox("Prioridade:", ["Todas", "Urgente", "Alta", "Normal", "Baixa"])
    with col3:
        # Ordena√ß√£o
        ordenacao = st.selectbox("Ordenar por:", ["Mais Recente", "Mais Antiga", "Prioridade", "Status"])
    
    # Aplica filtros
    sols_filtradas = minhas_sols.copy()
    
    if status_filtro != "Todos":
        sols_filtradas = [s for s in sols_filtradas if s.get('status') == status_filtro]
    if prioridade_filtro != "Todas":
        sols_filtradas = [s for s in sols_filtradas if s.get('prioridade') == prioridade_filtro]
    
    # Aplica ordena√ß√£o
    if ordenacao == "Mais Recente":
        sols_filtradas.sort(key=lambda x: x.get('carimbo_data_hora', ''), reverse=True)
    elif ordenacao == "Mais Antiga":
        sols_filtradas.sort(key=lambda x: x.get('carimbo_data_hora', ''))
    elif ordenacao == "Prioridade":
        prioridade_ordem = {"Urgente": 0, "Alta": 1, "Normal": 2, "Baixa": 3}
        sols_filtradas.sort(key=lambda x: prioridade_ordem.get(x.get('prioridade', 'Normal'), 2))
    elif ordenacao == "Status":
        sols_filtradas.sort(key=lambda x: x.get('status', ''))
    
    # Lista as solicita√ß√µes
    st.markdown(f"### üìã Suas Solicita√ß√µes ({len(sols_filtradas)} encontrada(s))")
    
    if not sols_filtradas:
        st.info("üîç Nenhuma solicita√ß√£o encontrada com os filtros aplicados.")
        return
    
    for sol in sols_filtradas:
        numero = sol.get('numero_solicitacao_estoque')
        status = sol.get('status', 'N/A')
        prioridade = sol.get('prioridade', 'Normal')
        
        # Define cor do status
        status_colors = {
            'Solicita√ß√£o': 'üü°',
            'Suprimentos': 'üîµ', 
            'Em Cota√ß√£o': 'üü†',
            'Aguardando Aprova√ß√£o': 'üü£',
            'Aprovado': 'üü¢',
            'Reprovado': 'üî¥',
            'Pedido Finalizado': '‚úÖ'
        }
        
        # Define cor da prioridade
        prioridade_colors = {
            'Urgente': 'üö®',
            'Alta': 'üî¥',
            'Normal': 'üü°',
            'Baixa': 'üü¢'
        }
        
        status_icon = status_colors.get(status, '‚ö™')
        prioridade_icon = prioridade_colors.get(prioridade, 'üü°')
        
        with st.expander(f"{status_icon} Solicita√ß√£o #{numero} - {prioridade_icon} {prioridade}", 
                        expanded=False):
            
            # Informa√ß√µes principais
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.markdown(f"**üìÖ Data:** {sol.get('carimbo_data_hora', 'N/A')[:10] if sol.get('carimbo_data_hora') else 'N/A'}")
                st.markdown(f"**üè¢ Departamento:** {sol.get('departamento', 'N/A')}")
                st.markdown(f"**üìç Local:** {sol.get('local_aplicacao', 'N/A')}")
            
            with col2:
                st.markdown(f"**üìä Status:** {status}")
                st.markdown(f"**‚ö° Prioridade:** {prioridade}")
                req_interno = sol.get('numero_requisicao_interno')
                st.markdown(f"**üìã Req. Interna:** {req_interno if req_interno else 'N√£o lan√ßada'}")
            
            with col3:
                valor_est = sol.get('valor_estimado') or sol.get('valor_final')
                st.markdown(f"**üí∞ Valor:** {format_brl(valor_est) if valor_est else 'N/A'}")
                sla_dias = sol.get('sla_dias', 0)
                st.markdown(f"**‚è±Ô∏è SLA:** {sla_dias} dias √∫teis")
                
                # Calcula dias decorridos
                try:
                    if sol.get('carimbo_data_hora'):
                        from app import calcular_dias_uteis
                        data_inicio = datetime.datetime.fromisoformat(sol['carimbo_data_hora'])
                        dias_decorridos = calcular_dias_uteis(data_inicio)
                        
                        if status not in ['Pedido Finalizado', 'Reprovado']:
                            if dias_decorridos > sla_dias:
                                st.markdown(f"**‚ö†Ô∏è Dias:** {dias_decorridos} (Em atraso)")
                            else:
                                st.markdown(f"**üìÖ Dias:** {dias_decorridos}")
                        else:
                            sla_cumprido = sol.get('sla_cumprido', 'N/A')
                            st.markdown(f"**‚úÖ SLA:** {sla_cumprido}")
                except:
                    st.markdown("**üìÖ Dias:** N/A")
            
            # Descri√ß√£o
            if sol.get('descricao'):
                st.markdown("**üìù Descri√ß√£o:**")
                st.info(sol['descricao'])
            
            # Itens (resumo)
            if sol.get('itens'):
                st.markdown("**üì¶ Itens Solicitados:**")
                total_itens = len(sol['itens'])
                st.write(f"‚Ä¢ {total_itens} item(ns) solicitado(s)")
                
                # Mostra primeiros 3 itens
                for i, item in enumerate(sol['itens'][:3]):
                    nome_item = item.get('nome', item.get('codigo', 'Item'))
                    qtd = item.get('quantidade', 1)
                    unidade = item.get('unidade', 'UN')
                    st.write(f"  - {nome_item}: {qtd} {unidade}")
                
                if total_itens > 3:
                    st.write(f"  ... e mais {total_itens - 3} item(ns)")
            
            # Hist√≥rico de etapas (resumo)
            if sol.get('historico_etapas'):
                with st.expander("üìö Hist√≥rico de Etapas"):
                    for etapa in sol['historico_etapas']:
                        data_etapa = etapa.get('data_entrada', '')
                        if data_etapa:
                            try:
                                data_formatada = datetime.datetime.fromisoformat(data_etapa).strftime("%d/%m/%Y %H:%M")
                            except:
                                data_formatada = data_etapa
                        else:
                            data_formatada = 'N/A'
                        
                        usuario_etapa = etapa.get('usuario', 'Sistema')
                        obs_etapa = etapa.get('observacoes', '')
                        
                        st.markdown(f"‚Ä¢ **{etapa.get('etapa', 'N/A')}** - {data_formatada} - {usuario_etapa}")
                        if obs_etapa:
                            st.markdown(f"  *{obs_etapa}*")
            
            # Aprova√ß√µes (se houver)
            if sol.get('aprovacoes'):
                with st.expander("‚úÖ Aprova√ß√µes"):
                    for aprov in sol['aprovacoes']:
                        nome_aprovador = aprov.get('nome_aprovador', 'N/A')
                        status_aprov = aprov.get('status', 'N/A')
                        data_aprov = aprov.get('data_aprovacao', '')
                        
                        if data_aprov:
                            try:
                                data_formatada = datetime.datetime.fromisoformat(data_aprov).strftime("%d/%m/%Y %H:%M")
                            except:
                                data_formatada = data_aprov
                        else:
                            data_formatada = 'N/A'
                        
                        icon_aprov = "‚úÖ" if status_aprov == "Aprovado" else "‚ùå"
                        st.markdown(f"{icon_aprov} **{status_aprov}** por {nome_aprovador} - {data_formatada}")
                        
                        if aprov.get('observacoes'):
                            st.markdown(f"*{aprov['observacoes']}*")
    
    # Estat√≠sticas adicionais
    if len(minhas_sols) > 0:
        st.markdown("---")
        st.markdown("### üìà Suas Estat√≠sticas")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # Distribui√ß√£o por status
            status_count = {}
            for sol in minhas_sols:
                status = sol.get('status', 'N/A')
                status_count[status] = status_count.get(status, 0) + 1
            
            if status_count:
                st.markdown("**üìä Por Status:**")
                for status, count in sorted(status_count.items()):
                    st.write(f"‚Ä¢ {status}: {count}")
        
        with col2:
            # Distribui√ß√£o por prioridade
            prioridade_count = {}
            for sol in minhas_sols:
                prioridade = sol.get('prioridade', 'Normal')
                prioridade_count[prioridade] = prioridade_count.get(prioridade, 0) + 1
            
            if prioridade_count:
                st.markdown("**‚ö° Por Prioridade:**")
                for prioridade, count in sorted(prioridade_count.items()):
                    st.write(f"‚Ä¢ {prioridade}: {count}")
